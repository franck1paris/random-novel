<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:os="http://www.mulesoft.org/schema/mule/os" xmlns:file="http://www.mulesoft.org/schema/mule/file"
	xmlns:batch="http://www.mulesoft.org/schema/mule/batch"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd">
	<sub-flow name="core-session" doc:id="c216d882-1b6c-4857-90b6-5a99890b0812">
		<flow-ref doc:name="fetch-littre-word" doc:id="a49de072-5762-40c8-b01c-33a2d6c49660" name="fetch-littre-word" />
		<ee:transform doc:name="Set lang_array, init prev_lang" doc:id="433fe1f0-2f59-4f7c-be7f-cf941c91dac8">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="lang_array"><![CDATA[%dw 2.0
output application/json
---
[ "JA", "DE", "PL", "IT", "NL", "FR" ]]]></ee:set-variable>
				<ee:set-variable variableName="prev_lang"><![CDATA[%dw 2.0
output application/json
---
"FR"]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<foreach doc:name="For Each lang in the array" doc:id="d7b0d7f5-3f83-4da8-8d09-d168a2c5e2ae" collection="#[vars.lang_array]">
			<ee:transform doc:name="set variables text, source_lang, target_lang" doc:id="cd83f9bc-13d6-42c5-a5df-657d8206e7f7">
			<ee:message>
			</ee:message>
			<ee:variables>
				<ee:set-variable variableName="source_lang"><![CDATA[%dw 2.0
output application/json
---
vars.prev_lang]]></ee:set-variable>
				<ee:set-variable variableName="target_lang"><![CDATA[%dw 2.0
output application/json
---
payload]]></ee:set-variable>
				<ee:set-variable variableName="text"><![CDATA[%dw 2.0
output application/json
---
vars.word]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
			<flow-ref doc:name="translate-word" doc:id="a3df2326-b43e-4b3a-857d-5e85a6d6c0c3" name="translate-word" />
			<set-variable doc:name="Update prev_lang" doc:id="3b74100f-ae69-4cfc-82c3-d2353b374719" variableName="prev_lang" value="#[payload]" />
			<set-variable value="#[%dw 2.0
output application/json
---
(vars.wordsWritten default 0) + 1]" doc:name="increment wordsWritten" doc:id="a4230fdd-472e-436f-98ee-c6f1d62bcb3d" variableName="wordsWritten" />
		</foreach>
		<file:write doc:name="Add word to novel" doc:id="fbc81a44-ef89-4627-84f9-3df3064469c9" config-ref="File_Config" path="novel.txt" mode="APPEND">
			<file:content><![CDATA[#[%dw 2.0
output text/plain
---
vars.word ++ " "]]]></file:content>
		</file:write>
		<choice doc:name="Choice" doc:id="5af149a4-7264-4ba4-bd16-96d88fa3e2ca" >
			<when expression="#[(vars.durationSession mod 50) == 0 and (vars.durationSession &gt; 0 and vars.charactersTranslatedMonthly &lt; p(&quot;deepl.monthlyLimit&quot;) and vars.charactersTranslatedDaily &lt; p('deepl.dailyLimit'))]">
				<set-variable value="#[vars.durationSession - 1]" doc:name="decrement durationSession" doc:id="9910c64b-ea2a-4e93-88f7-b29e7259a7b9" variableName="durationSession" />
				<flow-ref doc:name="still-motivated-verifier" doc:id="b1a44d92-91a4-47d1-af95-394e254a1e3c" name="still-motivated-verifier" />
			</when>
			<when expression="#[vars.durationSession &gt; 0 and vars.charactersTranslatedMonthly &lt; p(&quot;deepl.monthlyLimit&quot;) and vars.charactersTranslatedDaily &lt; p('deepl.dailyLimit')]">
				<set-variable value="#[vars.durationSession - 1]" doc:name="decrement durationSession" doc:id="6ccdfff0-7cf5-4aeb-a4cf-7ca3b1a5a062" variableName="durationSession" />
				<flow-ref doc:name="core-session" doc:id="1909e1f8-ece0-4e4e-9318-d456f812763c" name="core-session" />
			</when>
			<otherwise>
				<logger level="INFO" doc:name="End of session" doc:id="c3fec640-6168-4c95-b644-7656fdbc742d" message="End of session" />
			</otherwise>
		</choice>
	</sub-flow>
	<sub-flow name="writing-session" doc:id="1fa11c6d-f067-45d0-a950-e6539d411ef0" >
		<os:retrieve-all doc:name="Retrieve all from monitoring" doc:id="82775e4b-953f-424e-998f-548fc416f77c" objectStore="Object_store_Monitoring" target="monitoring" />
		<ee:transform doc:name="init durationSession, wordsWritten, charactersTranslated" doc:id="c27e839b-ac93-4a78-a61a-aeff3fa85732">
			<ee:message />
			<ee:variables>
				<ee:set-variable variableName="durationSession"><![CDATA[%dw 2.0
output application/json
---
313 as Number]]></ee:set-variable>
				<ee:set-variable variableName="wordsWritten"><![CDATA[%dw 2.0
output application/java
---
(vars.monitoring.wordsWritten default 0) as Number]]></ee:set-variable>
				<ee:set-variable variableName="charactersTranslatedDaily"><![CDATA[%dw 2.0
var currentHour = now() as String {format: "HH"}
output application/java
---
(if (currentHour == "00") 0 else (vars.monitoring.charactersTranslatedDaily default 0)) as Number]]></ee:set-variable>
				<ee:set-variable variableName="charactersTranslatedMonthly"><![CDATA[%dw 2.0
var currentDay = now() as String {format: "dd"}
output application/java
---
(if (currentDay == "01") 0 else (vars.monitoring.charactersTranslatedMonthly default 0)) as Number]]></ee:set-variable>
			</ee:variables>
		</ee:transform>
		<flow-ref doc:name="core-session" doc:id="d458ac64-3c62-43f6-8510-20da2d5830ab" name="core-session" />
		<os:store doc:name="Store wordsWritten in monitoring" doc:id="374c6b79-0dfb-4d6e-890e-482105a3f983" key="wordsWritten" objectStore="Object_store_Monitoring">
			<os:value><![CDATA[#[%dw 2.0
output application/json
---
vars.wordsWritten]]]></os:value>
		</os:store>
		<os:store doc:name="StoreStore charactersTranslatedDaily in monitoring" doc:id="b5577019-3e33-4c5c-8232-79db85b658f5" key="charactersTranslatedDaily" failOnNullValue="false" objectStore="Object_store_Monitoring">
			<os:value><![CDATA[#[%dw 2.0
output application/json
---
vars.charactersTranslatedDaily]]]></os:value>
		</os:store>
		<os:store doc:name="StoreStore charactersTranslatedMonthly in monitoring" doc:id="ae72ad10-2611-452d-a555-553d3b9a9644" key="charactersTranslatedMonthly" failOnNullValue="false" objectStore="Object_store_Monitoring">
			<os:value><![CDATA[#[%dw 2.0
output application/json
---
vars.charactersTranslatedMonthly]]]></os:value>
		</os:store>
	</sub-flow>
	<sub-flow name="print-novel" doc:id="a505f6f7-5b9c-4806-9576-1c27fd5dce58" >
		<file:read doc:name="Read" doc:id="e81ca09e-8460-402f-b40f-7f4ac7c49917" config-ref="File_Config" path="novel.txt" />
		<logger level="INFO" doc:name="print novel" doc:id="0098d42a-0da0-4ca2-b2d9-b454c35ff214" message="#[payload]"/>
	</sub-flow>
	<sub-flow name="delete-novel" doc:id="d2d00586-2d29-4247-b588-1bee87ba236c" >
		<file:delete doc:name="Delete" doc:id="e8ebd03f-0bb6-4cad-b68b-e733eebdd9d6" config-ref="File_Config" path="novel.txt"/>
		<logger level="INFO" doc:name="delete novel" doc:id="92912845-61e3-490f-8bc3-d8f6ee65a3ef" message="Delete completed" />
	</sub-flow>
</mule>
